{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\stalk\\\\jm-blog-platform\\\\src\\\\components\\\\articles-list\\\\article.js\";\nimport React, { useEffect, useState } from 'react';\nimport { connect } from 'react-redux';\nimport { Link } from 'react-router-dom';\nimport { getDate } from '../../helper';\nimport * as actions from '../../redux/actions';\nimport { ArtickesLikeImg, ArticlesDate, ArticlesDescription, ArticlesHeader, ArticlesInfo, ArticlesItem, ArticlesLikesCount, ArticlesStats, ArticlesTag, ArticlesTagsWrap, articlesTitle, ArticlesUserImage, ArticlesUserInfoWrap, ArticlesUserInfoGroup, ArticlesUsername } from '../../styled-components';\nimport { articleUrl } from '../../routes';\nimport activeLikeSrc from \"../../images/like-active.svg\";\nimport disabledLikeSrc from \"../../images/like-disabled.svg\";\n\nconst mapStateToProps = state => {\n  const {\n    likesStateOnServer,\n    addLikeRequestState\n  } = state;\n  console.log(state);\n  const isLikeChangedOnServer = addLikeRequestState === 'finished';\n  return {\n    likesStateOnServer,\n    isLikeChangedOnServer,\n    addLikeRequestState\n  };\n};\n\nconst actionCreator = {\n  addLike: actions.addLike\n};\n\nconst Article = props => {\n  const {\n    articles,\n    fakeLikes,\n    setFakeLikes,\n    likesStateOnServer,\n    addLike,\n    addLikeRequestState\n  } = props;\n  const [getLikeInfoByClickOnItem, setLikeByClick] = useState([]);\n  const [diffElement, setDiffElement] = useState({});\n  const clickedLike = getLikeInfoByClickOnItem[getLikeInfoByClickOnItem.length - 1];\n\n  const addLikeRequest = () => {\n    const thisLikeRequestAlreadySend = addLikeRequestState.some(el => el === clickedLike.id);\n\n    if (thisLikeRequestAlreadySend) {\n      console.log('запрос на изменение этого лайка уже отправлен');\n      return false;\n    }\n\n    console.log('fakeLikesState:', fakeLikes);\n    console.log('clickedLike:', clickedLike);\n    console.log('likesStateOnServer:', likesStateOnServer);\n    addLike(clickedLike);\n  };\n\n  const repeatLikeChangeRequest = () => {\n    console.log('проверяем соответствие фейк-лайков со значениями на сервере...');\n    const newLikesState = likesStateOnServer.map(serverLikeState => {\n      const findEl = fakeLikes.find(fakeLike => fakeLike.id === serverLikeState.id); // объединить фейковые лайки и те которые пришли от сервера в один объект\n      // для удобного сравнения\n\n      if (findEl) return {\n        id: findEl.id,\n        slug: findEl.slug,\n        isLiked: findEl.isLiked,\n        isLikedOnServer: serverLikeState.isFavorited\n      };\n      return serverLikeState;\n    });\n    setDiffElement(() => newLikesState.find(el => el.isLiked !== el.isLikedOnServer));\n    console.log('diff element:', diffElement);\n    if (diffElement !== undefined && Object.keys(diffElement).length > 0) addLike(diffElement);\n    return false;\n  };\n\n  useEffect(() => {\n    if (clickedLike !== undefined) addLikeRequest();\n  }, [clickedLike]);\n  useEffect(() => {\n    if (likesStateOnServer !== undefined && likesStateOnServer.length !== 0) {\n      console.log('xd???');\n      repeatLikeChangeRequest();\n    }\n  }, [diffElement, clickedLike]);\n\n  const renderArticle = () => {\n    return articles.map(article => {\n      const {\n        author,\n        createdAt,\n        description,\n        id,\n        tagList,\n        title,\n        slug\n      } = article;\n      const {\n        username,\n        image\n      } = author;\n      const dateDiff = getDate(createdAt);\n\n      const renderTagList = () => tagList.map(tag => /*#__PURE__*/React.createElement(ArticlesTag, {\n        key: tag.id,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 98,\n          columnNumber: 30\n        }\n      }, tag.title)); // визуальное изменение лайка для пользователя\n\n\n      const getFakeLike = () => {\n        if (fakeLikes === undefined) return null;\n        return fakeLikes.filter(el => el.id === id)[0];\n      }; // рендер лайка\n\n\n      const fakeLikeSrc = () => {\n        if (getFakeLike() === undefined) return disabledLikeSrc;\n        return getFakeLike().isLiked ? activeLikeSrc : disabledLikeSrc;\n      }; // рендер счетчика лайков\n\n\n      const fakeLikeCounter = () => {\n        if (getFakeLike() === undefined) return 0;\n        return getFakeLike().likesCount;\n      };\n      /*\n          1) пользователь нажимает на фейк-лайк\n          2) отправляется запрос на сервер с измененным фейк-состоянием\n             если пользователь нажимает на лайк пока запрос идет, то повторный запрос не отправляется\n          3) приходит ответ с изменённым состоянием\n             после ответа проверяем, состояние фейк-лайка такое же как и у обновлённого состояния?\n             если да, то оставляем всё как есть\n             если нет, то снова отправляем запрос на сервер\n      */\n\n\n      const handleOnLikeArticle = () => {\n        setFakeLikes(state => {\n          const newState = state.map(el => {\n            if (el.id === id) {\n              return { ...el,\n                isLiked: !el.isLiked,\n                likesCount: el.isLiked ? el.likesCount - 1 : el.likesCount + 1\n              };\n            }\n\n            return el;\n          });\n          return newState;\n        });\n        setLikeByClick(state => {\n          const newLike = {\n            id,\n            isLiked: getFakeLike().isLiked,\n            slug\n          };\n\n          if (state.some(el => el.id === id)) {\n            return [...state.filter(el => el.id !== id), newLike];\n          }\n\n          ;\n          return [...state, newLike];\n        });\n      };\n\n      return /*#__PURE__*/React.createElement(ArticlesItem, {\n        key: id,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 152,\n          columnNumber: 9\n        }\n      }, /*#__PURE__*/React.createElement(ArticlesInfo, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 153,\n          columnNumber: 11\n        }\n      }, /*#__PURE__*/React.createElement(ArticlesHeader, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 154,\n          columnNumber: 13\n        }\n      }, /*#__PURE__*/React.createElement(Link, {\n        style: articlesTitle,\n        to: articleUrl(slug),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 155,\n          columnNumber: 15\n        }\n      }, title), /*#__PURE__*/React.createElement(ArticlesStats, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 158,\n          columnNumber: 15\n        }\n      }, /*#__PURE__*/React.createElement(ArtickesLikeImg, {\n        onClick: handleOnLikeArticle,\n        src: fakeLikeSrc(),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 159,\n          columnNumber: 17\n        }\n      }), /*#__PURE__*/React.createElement(ArticlesLikesCount, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 163,\n          columnNumber: 17\n        }\n      }, fakeLikeCounter()))), /*#__PURE__*/React.createElement(ArticlesTagsWrap, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 166,\n          columnNumber: 13\n        }\n      }, renderTagList()), /*#__PURE__*/React.createElement(ArticlesDescription, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 170,\n          columnNumber: 13\n        }\n      }, description)), /*#__PURE__*/React.createElement(ArticlesUserInfoWrap, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 175,\n          columnNumber: 11\n        }\n      }, /*#__PURE__*/React.createElement(ArticlesUserInfoGroup, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 176,\n          columnNumber: 13\n        }\n      }, /*#__PURE__*/React.createElement(ArticlesUsername, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 177,\n          columnNumber: 15\n        }\n      }, username), /*#__PURE__*/React.createElement(ArticlesDate, {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 178,\n          columnNumber: 15\n        }\n      }, dateDiff)), /*#__PURE__*/React.createElement(ArticlesUserImage, {\n        src: image,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 180,\n          columnNumber: 13\n        }\n      })));\n    });\n  };\n\n  return renderArticle();\n};\n\nexport default connect(mapStateToProps, actionCreator)(Article);","map":{"version":3,"sources":["C:/Users/stalk/jm-blog-platform/src/components/articles-list/article.js"],"names":["React","useEffect","useState","connect","Link","getDate","actions","ArtickesLikeImg","ArticlesDate","ArticlesDescription","ArticlesHeader","ArticlesInfo","ArticlesItem","ArticlesLikesCount","ArticlesStats","ArticlesTag","ArticlesTagsWrap","articlesTitle","ArticlesUserImage","ArticlesUserInfoWrap","ArticlesUserInfoGroup","ArticlesUsername","articleUrl","mapStateToProps","state","likesStateOnServer","addLikeRequestState","console","log","isLikeChangedOnServer","actionCreator","addLike","Article","props","articles","fakeLikes","setFakeLikes","getLikeInfoByClickOnItem","setLikeByClick","diffElement","setDiffElement","clickedLike","length","addLikeRequest","thisLikeRequestAlreadySend","some","el","id","repeatLikeChangeRequest","newLikesState","map","serverLikeState","findEl","find","fakeLike","slug","isLiked","isLikedOnServer","isFavorited","undefined","Object","keys","renderArticle","article","author","createdAt","description","tagList","title","username","image","dateDiff","renderTagList","tag","getFakeLike","filter","fakeLikeSrc","disabledLikeSrc","activeLikeSrc","fakeLikeCounter","likesCount","handleOnLikeArticle","newState","newLike"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from 'react';\nimport { connect } from 'react-redux';\nimport { Link } from 'react-router-dom';\nimport { getDate } from '../../helper';\nimport * as actions from '../../redux/actions';\nimport {\n  ArtickesLikeImg, ArticlesDate, ArticlesDescription,\n  ArticlesHeader,\n  ArticlesInfo, ArticlesItem, ArticlesLikesCount,\n  ArticlesStats,\n  ArticlesTag, ArticlesTagsWrap,\n  articlesTitle, ArticlesUserImage, ArticlesUserInfoWrap, ArticlesUserInfoGroup, ArticlesUsername,\n} from '../../styled-components';\nimport { articleUrl } from '../../routes';\nimport activeLikeSrc from '../../images/like-active.svg';\nimport disabledLikeSrc from '../../images/like-disabled.svg';\n\nconst mapStateToProps = (state) => {\n  const { likesStateOnServer, addLikeRequestState } = state;\n  console.log(state);\n\n  const isLikeChangedOnServer = addLikeRequestState === 'finished';\n\n  return { likesStateOnServer, isLikeChangedOnServer, addLikeRequestState};\n};\n\nconst actionCreator = {\n  addLike: actions.addLike,\n};\n\nconst Article = (props) => {\n  const {\n    articles, fakeLikes, setFakeLikes, likesStateOnServer,\n    addLike, addLikeRequestState\n  } = props;\n  const [getLikeInfoByClickOnItem, setLikeByClick] = useState([]);\n  const [diffElement, setDiffElement] = useState({});\n\n\n  const clickedLike = getLikeInfoByClickOnItem[getLikeInfoByClickOnItem.length - 1];\n\n  const addLikeRequest = () => {\n    const thisLikeRequestAlreadySend = addLikeRequestState.some((el) => el === clickedLike.id);\n    if (thisLikeRequestAlreadySend) {\n      console.log('запрос на изменение этого лайка уже отправлен');\n      return false;\n    }\n    console.log('fakeLikesState:', fakeLikes);\n    console.log('clickedLike:', clickedLike);\n    console.log('likesStateOnServer:', likesStateOnServer);\n    addLike(clickedLike);\n  }\n\n  const repeatLikeChangeRequest = () => {\n    console.log('проверяем соответствие фейк-лайков со значениями на сервере...');\n    const newLikesState = likesStateOnServer.map((serverLikeState) => {\n      const findEl = fakeLikes.find((fakeLike) => fakeLike.id === serverLikeState.id);\n\n      // объединить фейковые лайки и те которые пришли от сервера в один объект\n      // для удобного сравнения\n      if (findEl) return {\n        id: findEl.id,\n        slug: findEl.slug,\n        isLiked: findEl.isLiked,\n        isLikedOnServer: serverLikeState.isFavorited,\n      };\n      return serverLikeState;\n    });\n\n    setDiffElement(() => newLikesState.find((el) => el.isLiked !== el.isLikedOnServer));\n\n    console.log('diff element:', diffElement);\n    if (diffElement !== undefined && Object.keys(diffElement).length > 0) addLike(diffElement);\n    return false;\n  };\n\n\n  useEffect(() => {\n    if (clickedLike !== undefined) addLikeRequest();\n  }, [clickedLike]);\n\n  useEffect(() => {\n    if (likesStateOnServer !== undefined && likesStateOnServer.length !== 0) {\n      console.log('xd???')\n      repeatLikeChangeRequest();\n    }\n  }, [diffElement, clickedLike]);\n\n  const renderArticle = () => {\n    return articles.map((article) => {\n      const {\n        author, createdAt, description, id, tagList, title, slug,\n      } = article;\n      const { username, image } = author;\n      const dateDiff = getDate(createdAt);\n\n      const renderTagList = () => (\n        tagList.map((tag) => <ArticlesTag key={tag.id}>{tag.title}</ArticlesTag>)\n      );\n\n      // визуальное изменение лайка для пользователя\n      const getFakeLike = () => {\n        if (fakeLikes === undefined) return null;\n        return fakeLikes.filter((el) => el.id === id)[0];\n      };\n\n      // рендер лайка\n      const fakeLikeSrc = () => {\n        if (getFakeLike() === undefined) return disabledLikeSrc;\n        return getFakeLike().isLiked ? activeLikeSrc : disabledLikeSrc;\n      };\n\n      // рендер счетчика лайков\n      const fakeLikeCounter = () => {\n        if (getFakeLike() === undefined) return 0;\n        return getFakeLike().likesCount;\n      };\n      /*\n          1) пользователь нажимает на фейк-лайк\n          2) отправляется запрос на сервер с измененным фейк-состоянием\n             если пользователь нажимает на лайк пока запрос идет, то повторный запрос не отправляется\n          3) приходит ответ с изменённым состоянием\n             после ответа проверяем, состояние фейк-лайка такое же как и у обновлённого состояния?\n             если да, то оставляем всё как есть\n             если нет, то снова отправляем запрос на сервер\n      */\n      const handleOnLikeArticle = () => {\n        setFakeLikes((state) => {\n          const newState = state.map((el) => {\n            if (el.id === id) {\n              return {\n                ...el,\n                isLiked: !el.isLiked,\n                likesCount: (el.isLiked) ? el.likesCount - 1 : el.likesCount + 1,\n              };\n            }\n            return el;\n          });\n          return newState;\n        });\n\n        setLikeByClick((state) => {\n          const newLike = { id, isLiked: getFakeLike().isLiked, slug };\n          if (state.some((el) => el.id === id)) {\n            return [...state.filter((el) => el.id !== id), newLike];\n          };\n          return [...state, newLike];\n        });\n      };\n\n      return (\n        <ArticlesItem key={id}>\n          <ArticlesInfo>\n            <ArticlesHeader>\n              <Link style={articlesTitle} to={articleUrl(slug)}>\n                {title}\n              </Link>\n              <ArticlesStats>\n                <ArtickesLikeImg\n                  onClick={handleOnLikeArticle}\n                  src={fakeLikeSrc()}\n                />\n                <ArticlesLikesCount>{fakeLikeCounter()}</ArticlesLikesCount>\n              </ArticlesStats>\n            </ArticlesHeader>\n            <ArticlesTagsWrap>\n              {renderTagList()}\n            </ArticlesTagsWrap>\n\n            <ArticlesDescription>\n              {description}\n            </ArticlesDescription>\n          </ArticlesInfo>\n\n          <ArticlesUserInfoWrap>\n            <ArticlesUserInfoGroup>\n              <ArticlesUsername>{username}</ArticlesUsername>\n              <ArticlesDate>{dateDiff}</ArticlesDate>\n            </ArticlesUserInfoGroup>\n            <ArticlesUserImage src={image} />\n          </ArticlesUserInfoWrap>\n        </ArticlesItem>\n      );\n    });\n  }\n\n  return renderArticle();\n};\n\nexport default connect(mapStateToProps, actionCreator)(Article);\n"]},"metadata":{},"sourceType":"module"}